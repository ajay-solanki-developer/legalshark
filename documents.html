<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LegalShark · Documents</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="nav-loader.js"></script>
  <style>
    :root { --lf-bg:#0b0f19; --lf-surface:#111827; --lf-card:#0f172a; --lf-border:#1f2937; --lf-accent:#2563eb; --lf-primary:var(--lf-accent); --lf-radius:1rem; --lf-btn-shape:999px; --lf-density-y:.75rem; }
    [data-bs-theme="dark"]{ --bs-body-bg:var(--lf-bg); --bs-body-color:#e5e7eb; --bs-border-color:var(--lf-border); --bs-card-bg:var(--lf-card); --bs-card-border-color:var(--lf-border); --bs-tertiary-bg:var(--lf-surface); }
    .brand-badge{font-weight:700;color:var(--lf-primary)} .btn{border-radius:var(--lf-btn-shape)} .rounded-dna{border-radius:var(--lf-radius)!important}
    .sidebar{width:280px;background:var(--bs-tertiary-bg);border-right:1px solid var(--bs-border-color);position:fixed;top:0;bottom:0;left:0;z-index:1030;overflow-y:auto}
    .content-wrap{margin-left:280px} @media (max-width:991.98px){.sidebar{left:-100%;transition:left .2s ease}.sidebar.show{left:0}.content-wrap{margin-left:0}}
    .brand-header{background:linear-gradient(135deg,rgba(var(--bs-primary-rgb),.22),rgba(var(--bs-primary-rgb),.10) 60%,transparent 100%),var(--bs-body-bg);
      border-bottom:1px solid color-mix(in srgb,var(--lf-primary) 25%,var(--bs-border-color));backdrop-filter:saturate(120%) blur(6px)}
    body.lf-theme-gradient{background:radial-gradient(1200px 600px at -10% -10%, rgba(var(--bs-primary-rgb),.18), transparent 60%),linear-gradient(180deg, rgba(var(--bs-primary-rgb),.08), transparent 300px),var(--bs-body-bg)}
    .badge-soft{background:rgba(var(--bs-primary-rgb),.12); color:var(--bs-primary)}
  </style>
</head>
<body class="lf-theme-gradient">
  <!-- Sidebar -->
  <nav id="sidebar" class="sidebar p-3">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-scales me-2 text-primary"></i><span class="brand-badge">LegalShark</span>
    </div>
    <div class="mb-3"><input id="navSearch" type="search" class="form-control" placeholder="Search…"></div>
    <small class="text-uppercase text-secondary">Navigation</small>
    <div id="mainNav"></div>
    <hr/><div class="d-grid gap-2"><button class="btn btn-outline-secondary" id="toggleTheme"><i class="bi bi-moon-stars me-2"></i>Toggle Dark</button></div>
  </nav>

  <!-- Header -->
  <header class="content-wrap brand-header sticky-top">
    <div class="container-fluid py-2">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary d-lg-none" id="sidebarToggle"><i class="bi bi-list"></i></button>
          <span class="fw-semibold">Documents</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <input id="fltClient" class="form-control" placeholder="Filter client…" style="max-width:220px">
          <input id="fltTicket" class="form-control" placeholder="Filter ticket…" style="max-width:180px">
          <select id="fltCat" class="form-select" style="max-width:180px">
            <option value="">All categories</option>
            <option>Disclosure</option><option>Evidence</option><option>Correspondence</option><option>Filing</option>
          </select>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#docModal"><i class="bi bi-upload"></i> Add Document</button>
          <button id="btnExport" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Export</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="content-wrap">
    <div class="container-fluid py-4">
      <div class="card rounded-dna">
        <div class="table-responsive">
          <table class="table align-middle mb-0" id="docTable">
            <thead><tr><th>Date</th><th>Client</th><th>Ticket</th><th>Category</th><th>Filename</th><th class="text-end">Size</th><th class="text-end">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card-footer small text-secondary">Files are stored locally (browser). Keep uploads small (demo).</div>
      </div>
    </div>
  </main>

  <!-- Add Doc Modal -->
  <div class="modal fade" id="docModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add Document</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Client</label><input id="dClient" list="clientList" class="form-control"/><datalist id="clientList"></datalist></div>
          <div class="col-6"><label class="form-label">Ticket #</label><input id="dTicket" list="ticketList" class="form-control"/><datalist id="ticketList"></datalist></div>
          <div class="col-6"><label class="form-label">Category</label>
            <select id="dCat" class="form-select"><option>Disclosure</option><option>Evidence</option><option>Correspondence</option><option>Filing</option></select>
          </div>
          <div class="col-6"><label class="form-label">Tags (comma)</label><input id="dTags" class="form-control" placeholder="camera, dashcam"/></div>
          <div class="col-12"><label class="form-label">File</label><input id="dFile" type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt"/></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" id="btnSaveDoc">Save</button></div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Sidebar + Theme
    document.getElementById('sidebarToggle')?.addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('show'));
    document.getElementById('toggleTheme')?.addEventListener('click',()=>{const h=document.documentElement;const cur=h.getAttribute('data-bs-theme')||'light';const nxt=cur==='dark'?'light':'dark';h.setAttribute('data-bs-theme',nxt);localStorage.setItem('ls_theme',nxt);});
    (function(){const saved=localStorage.getItem('ls_theme'); if(saved) document.documentElement.setAttribute('data-bs-theme', saved);})();

    // Data layer
    const K={clients:'ls_clients',tickets:'ls_tickets',docs:'ls_documents'};
    const _get=(k,f)=>{try{return JSON.parse(localStorage.getItem(k)|| (f!==undefined?JSON.stringify(f):'null'));}catch{return f;}};
    const _set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const nextId=a=>(a.length?Math.max(...a.map(x=>x.id||0)):0)+1;
    function seed(){
      if(!_get(K.clients)){_set(K.clients,[{firstName:'John',lastName:'Carter'},{firstName:'Emily',lastName:'Johnson'}]);}
      if(!_get(K.tickets)){_set(K.tickets,[{number:'HTA-2025-010',client:'John Carter'},{number:'HTA-2025-011',client:'Emily Johnson'}]);}
      if(!_get(K.docs)){_set(K.docs,[]);}
    } seed();

    const Clients={all(){return _get(K.clients,[])||[];}};
    const Tickets={all(){return _get(K.tickets,[])||[];}};
    const Docs={
      all(){return _get(K.docs,[])||[];},
      add(d){const a=Docs.all(); d.id=nextId(a); a.push(d); _set(K.docs,a); return d;},
      remove(id){const a=Docs.all().filter(x=>x.id!=id); _set(K.docs,a);}
    };

    // Populate lists
    document.getElementById('clientList').innerHTML = Clients.all().map(c=>`<option value="${(c.firstName||'')+' '+(c.lastName||'')}">`).join('');
    document.getElementById('ticketList').innerHTML = Tickets.all().map(t=>`<option value="${t.number}">`).join('');

    function fmtSize(n){ if(!n) return ''; const kb=n/1024; if(kb<1024) return kb.toFixed(1)+' KB'; return (kb/1024).toFixed(2)+' MB'; }

    function render(){
      const tbody=document.querySelector('#docTable tbody');
      const tClient=(fltClient.value||'').toLowerCase();
      const tTicket=(fltTicket.value||'').toLowerCase();
      const tCat=fltCat.value||'';
      tbody.innerHTML = Docs.all()
        .filter(d => (!tClient || (d.client||'').toLowerCase().includes(tClient)) && (!tTicket || (d.ticket||'').toLowerCase().includes(tTicket)) && (!tCat || d.category===tCat))
        .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''))
        .map(d=>`<tr>
          <td>${(d.createdAt||'').slice(0,10)}</td>
          <td><a href="./tickets.html?client=${encodeURIComponent(d.client||'')}">${d.client||''}</a></td>
          <td>${d.ticket||''}</td>
          <td><span class="badge text-bg-primary bg-opacity-10 border border-primary-subtle">${d.category||''}</span></td>
          <td>${d.name||''}</td>
          <td class="text-end">${fmtSize(d.size||0)}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              ${d.dataUrl?`<button class="btn btn-outline-secondary" data-dl="${d.id}">Download</button>`:''}
              <button class="btn btn-outline-danger" data-del="${d.id}"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`).join('') || `<tr><td colspan="7" class="text-center text-secondary py-4">No documents yet.</td></tr>`;
    }

    // Save document (stores small files inline as data URL; keep < 1–2MB for demo)
    document.getElementById('btnSaveDoc').addEventListener('click', async ()=>{
      const file = dFile.files[0]; if(!file){ alert('Choose a file'); return; }
      const reader = new FileReader();
      reader.onload = ()=>{
        Docs.add({
          client:dClient.value.trim(), ticket:dTicket.value.trim(), category:dCat.value, tags:(dTags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
          name:file.name, size:file.size, type:file.type, dataUrl:reader.result, createdAt:new Date().toISOString()
        });
        bootstrap.Modal.getInstance(document.getElementById('docModal'))?.hide(); dFile.value=''; render();
      };
      reader.readAsDataURL(file);
    });

    // Download / Delete
    document.getElementById('docTable').addEventListener('click',(e)=>{
      const dl = e.target.closest('[data-dl]'); if(dl){
        const id=Number(dl.getAttribute('data-dl')); const d=Docs.all().find(x=>x.id===id); if(!d||!d.dataUrl) return;
        fetch(d.dataUrl).then(r=>r.blob()).then(blob=>{
          const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:d.name||'document'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
      }
      const del = e.target.closest('[data-del]'); if(del){
        const id=Number(del.getAttribute('data-del')); if(confirm('Delete this document?')){ Docs.remove(id); render(); }
      }
    });

    // Export metadata CSV
    document.getElementById('btnExport').addEventListener('click',()=>{
      const rows=[['Date','Client','Ticket','Category','Name','Size(bytes)']].concat(Docs.all().map(d=>[(d.createdAt||'').slice(0,10),d.client||'',d.ticket||'',d.category||'',d.name||'',d.size||0]));
      const csv=rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=Object.assign(document.createElement('a'),{href:url,download:'documents.csv'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    render();
  </script>
</body>
</html>
